"""
Getting valid sentinel-2 dataset from SentinelHub

Script adopted from eo-learn land-cover-map example

get_s2_sentinelhub.py
"""

import numpy as np

from eolearn.core import EOPatch, EOTask, FeatureType, LinearWorkflow, LoadFromDisk, OverwritePermission, SaveToDisk


class SentinelHubValidData:
    """
    The SentinelHub's cloud mask is asumed to be found in eopatch.mask['CLM']
    """

    def __call__(self, eopatch):
        return np.logical_and(
            eopatch.mask["dataMask"].astype(np.bool), np.logical_not(eopatch.mask["CLM"].astype(np.bool))
        )


class CountValid(EOTask):
    """counts number of valid observations in time-series and stores the results in the timeless mask."""

    def __init__(self, count_what, feature_name):
        self.what = count_what
        self.name = feature_name

    def execute(self, eopatch):
        eopatch.add_feature(FeatureType.MASK_TIMELESS, self.name, np.count_nonzero(eopatch.mask[self.what], axis=0))

        return eopatch


class NormalizedDifferenceIndex(EOTask):
    """
    Defined Normalised Difference Index (NDI) between two bands A and B as:
    NDI = (A-B)/(A+B).
    """

    def __init__(self, feature_name, band_a, band_b):
        self.feature_name = feature_name
        self.band_a_fetaure_name = band_a.split("/")[0]
        self.band_b_fetaure_name = band_b.split("/")[0]
        self.band_a_fetaure_idx = int(band_a.split("/")[-1])
        self.band_b_fetaure_idx = int(band_b.split("/")[-1])

    def execute(self, eopatch):
        band_a = eopatch.data[self.band_a_fetaure_name][..., self.band_a_fetaure_idx]
        band_b = eopatch.data[self.band_b_fetaure_name][..., self.band_b_fetaure_idx]

        ndi = (band_a - band_b) / (band_a + band_b)

        eopatch.add_feature(FeatureType.DATA, self.feature_name, ndi[..., np.newaxis])

        return eopatch


class ConcatenateData(EOTask):
    """Task to concatenate data arrays along the last dimension"""

    def __init__(self, feature_name, feature_names_to_concatenate):
        self.feature_name = feature_name
        self.feature_names_to_concatenate = feature_names_to_concatenate

    def execute(self, eopatch):
        arrays = [eopatch.data[name] for name in self.feature_names_to_concatenate]

        eopatch.add_feature(FeatureType.DATA, self.feature_name, np.concatenate(arrays, axis=-1))

        return eopatch


class ValidDataFractionPredicate:
    """Predicate that defines if a frame from EOPatch's time-series is valid or not.
    Frame is valid, if the valid data fraction is above the specified threshold.
    """

    def __init__(self, threshold):
        self.threshold = threshold

    def __call__(self, array):
        coverage = np.sum(array.astype(np.uint8)) / np.prod(array.shape)
        return coverage > self.threshold
